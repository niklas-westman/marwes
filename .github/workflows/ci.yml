name: CI
# Continuous Integration workflow that runs on every pull request
# Validates code quality, type safety, tests, and build success before merging

on:
  pull_request:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  ci:
    uses: ./.github/workflows/_ci.yml

  changeset-check:
    name: changeset-check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changeset
        run: |
          if [ "${{ github.event.pull_request.user.login }}" = "github-actions[bot]" ]; then
            echo "Skipping changeset check for bot PRs"
            exit 0
          fi
          
          if [ -n "$(git diff --name-only origin/${{ github.base_ref }}..HEAD .changeset)" ]; then
            echo "✅ Changeset found"
            exit 0
          else
            echo "❌ No changeset found. Run 'pnpm changeset' if this PR should trigger a release."
            echo "   If this PR should NOT trigger a release, add a comment explaining why."
            exit 1
          fi
